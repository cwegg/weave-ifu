<?xml version="1.0" encoding="utf-8" ?>  

<root version="1.10" author="" cc_report="" report_verbosity="%%%">
  <!--
      This file represents a blank XML template (version indicated in <root>) that is ready to be filled with:

      1. Instrument configuration information
      2. Field observing constraints approprate to the...
      3. ...targets from "protofield" FITS files containing ~1500-2000 targets

      The SWG should create a page detailing the possible instrumental
      configurations and observing condition constraints to aid catalogue construction.

      A service that allows a series of radio buttons to be fixed that
      then outputs the correct PROGTEMP and OBSTEMP should be
      provided.
  -->
  
  <programme>
    <!-- Historical note:
	 This component is the ProgrammeDefinition XML: it must inserted by the SWG at .fits -> .xml converter stage
	 (prior to running configure).

         Each target has a PROGTEMP value, which defines:

         PROGTEMP = "NORBI.X"
	 N = i(N)strument configuration
	 O = (O)B length
	 R = (R)ed arm exposure code
	 B = (B)lue arm exposure code
	 I = B(I)nning in the spectral direction
	 X = Conte(X)tual OB actions (duplicate X times, dither pattern X times...)

         The per-target PROGTEMP values are grouped prior to when a concatenated "master catalogue" is created, so  
	 that targets with common PROGTEMP are observed in the same field.

    -->
    <spectrograph>
      <red_Arm speed="slow" resolution="%%%" binning_X="1" binning_Y="%%%" VPH="%%%"/> 
      <blue_Arm speed="slow" resolution="%%%" binning_X="1" binning_Y="%%%" VPH="%%%"/>
      <!-- 

         i(N)strument configuration: translated into "type", "VPH" etc, eg:                  [NORBI.X]
         =============================                                                        ^
         PROGTEMP     type    resolution   red_Arm   blue_Arm
	 1****.*      "MOS"   "low"        "VPH1"    "VPH1"
	 2****.*      "MOS"   "high"       "VPH2"    "VPH2"
	 3****.*      "MOS"   "high"       "VPH2"    "VPH3"
	 4****.*      "LIFU"  "low"        "VPH1"    "VPH1"
	 5****.*      "LIFU"  "high"       "VPH2"    "VPH2"
	 6****.*      "LIFU"  "high"       "VPH2"    "VPH3"
	 7****.*      "mIFU"  "low"        "VPH1"    "VPH1"
	 8****.*      "mIFU"  "high"       "VPH2"    "VPH2"
	 9****.*      "mIFU"  "high"       "VPH2"    "VPH3"

	 Some elements remain unchanged: readout is always "slow", spatial binning is always = 1x.

	 B(I)nning in the spectral direction:                                                [NORBI.X]
         =============================                                                            ^
         PROGTEMP     spectral binning
	 ****1.*      1x
	 ****2.*      2x
	 ****3.*      3x
	 ****4.*      4x

         (all other values forbidden)


        spectrograph: defines the the configuration for both arms of the Spectrograph
        (both arms are mandatory)        
        (all attributes mandatory)
        
        speed: arm readout speed for the program.Possible values "fast", "slow"                                              [fixed in template]
        resolution:  arm resolution for the program. Possible values are "low", "high"                                       [defined by PROGTEMP]
        binning_X: arm detector binning in spatial direction for the program. Possible values: "1","2","3","4" (pixels).     [fixed in template]
        binning_Y: arm detector binning in spectral direction for the program. Possible values: "1","2","3","4" (pixels).    [defined by PROGTEMP]
        VPH: Arm Grating; Possible Values are "n/a", "vph1","vph2" and "vp33". ("vph3" only for Blue Arm)                    [defined by PROGTEMP]
      -->
    </spectrograph>
    <exposures>

      <!-- The SWG should provide for a limited number of observing templates ("Exposures") here, with a fixed calibration recipe.

           (O)B length specifier:                                                            [NORBI.X]
           ========================                                                            ^

           OBs can either be total length* 30 minutes** (OB0), 1hr (OB1) or 2hr (OB2)

           * The "length" here refers to total time on-target(s) (including. overheads) rather than time on-target. A 20-minute OB will
	   generally comprise 17 minutes on-target and 3 minutes overhead.


           ** 30 minute OBs could be used in cases where there is only a short amount of dark time left (end / start of the night)
	   and/or for bright targets. Where condtions might only permit a further 30 minutes on MOS, OB0 could also be used. If
	   conditions subsequently clear: there is a danger that the other plate might not have configured in time. One option is to
	   repeat that 30 minute OB.
	   
	   (R)ed or (B)lue arm exposure code:                                                [NORBI.X]
	   ==================================                                                   ^^

           (NB. these are nominal for illustrative purposes and do not include r/o overhead in total OB execution time)

	   As each arm can be independently read out, mixed templates are possible. This is encoded in the penultimate 2 chars in PROGTEMP,
	   which correspond respectively to the Red and Blue arms:

	   CODE   TEXP (min) per exposure     OB0      OB1      OB2
	   0       -                          1x30     1x60m    1x120m
	   1      60                          -        -        2x60m
	   2      30                          -        2x30m    4x30m
	   3      20                          -        3x20m    6x20m
	   4      15                          2x15m    4x15m    8x15m
	   6      10                          3x10m    6x10m    12x10m

           In the Operational Rehearsals, we were using: 

           PROGTEMP = "11331" (MOS, LR, R:3x20mins, B:3x20mins)
           PROGTEMP = "22331" (MOS, HR-Blue, R:6x20mins, B:6x20mins)
           PROGTEMP = "32331" (MOS, HR-Green, R:6x20mins, B:6x20mins)

           Some RB combinations might be restricted due to excessive readout overheads, eg:

           PROGTEMP = "22601" (MOS, HR-Blue, R:4x30mins, B:1x120m)
	   The red arm here would incur an ~36 minute overhead readout penalty, and would not be completed at around the same time as the  arm.

           In the below example, we show a typical LR OpR2 OB equivalent to PROGTEMP = "11331":

      -->

      <exposure order="1" type="flat" arm="red" exp_time="20" cal_lamp="1" cal_lamp_filter_A="1" cal_lamp_filter_B="1" ff_ilu_1="0" ff_ilu_2="0" ff_ilu_3="0"/>
      <exposure order="1" type="flat" arm="blue" exp_time="20" cal_lamp="1" cal_lamp_filter_A="1" cal_lamp_filter_B="1" ff_ilu_1="0" ff_ilu_2="0" ff_ilu_3="0"/> 
      <exposure order="2" type="arc" arm="red" exp_time="25" cal_lamp="2" cal_lamp_filter_A="0" cal_lamp_filter_B="0" ff_ilu_1="45" ff_ilu_2="34" ff_ilu_3="56"/>
      <exposure order="2" type="arc" arm="blue" exp_time="25" cal_lamp="2" cal_lamp_filter_A="0" cal_lamp_filter_B="0" ff_ilu_1="45" ff_ilu_2="34" ff_ilu_3="56"/> 
      <exposure order="%%%" type="science" arm="%%%" exp_time="%%%" cal_lamp="0" cal_lamp_filter_A="0" cal_lamp_filter_B="0" ff_ilu_1="0" ff_ilu_2="0" ff_ilu_3="0"/>
      <exposure order="%%%" type="arc" arm="red" exp_time="25" cal_lamp="2" cal_lamp_filter_A="0" cal_lamp_filter_B="0" ff_ilu_1="45" ff_ilu_2="34" ff_ilu_3="56"/> <!-- [[ORDER undefined until exposure code known]]-->
      <exposure order="%%%" type="arc" arm="blue" exp_time="25" cal_lamp="2" cal_lamp_filter_A="0" cal_lamp_filter_B="0" ff_ilu_1="45" ff_ilu_2="34" ff_ilu_3="56"/> <!-- [[ORDER undefined until exposure code known]]-->
      

      <!--
	What do these values specifically mean?  
	exposures:defines the exposures of the OBs belonging to this Programme (all attributes mandatory)
        
        order: Order of execution of the exposure                                                                                                [auto-generated by FITS -> XML code]
        type: Exposure type. Possible values are: "Science", "arc", "flat", "bias", "standard"                                                   [auto-generated by FITS -> XML code]
        arm: Arm to perform the observation with. Possible values: "both", "red", "blue".                                                        [fixed in template]
        exp_time: Time of exposure (in secs).                                                                                                    [defined by PROGTEMP]
        cal_lamp: Possible values are, "1", "2", "3", "4" corresponding  to the lamp chosen.                                                     [fixed in template]
        cal_lamp_filter_A:Calibration lamp filter A: Possible values:"1", "2", "3",  "4", "5", "6" corresponding to the filter chosen.           [fixed in template]
        cal_lamp_filter_B:Calibration lamp filter B position. Possible values:"1", "2", "3", "4", "5", "6" corresponding to the filter chosen.   [fixed in template]
        ff_ilu_1:Arm flat field illumination Led 1. Possible values:[0-100] where 0  corresponds to Off and 100 to the max intensity.            [fixed in template]
        ff_ilu_2:Arm flat field illumination Led 2. Possible values:[0-100] where 0  corresponds to Off and 100 to the max intensity.            [fixed in template]
        ff_ilu_3:Arm flat field illumination Led 3. Possible values:[0-100] where 0  corresponds to Off and 100 to the max intensity.            [fixed in template]
      -->
    </exposures> 

      <!-- Some surveys have specific requirements for dithering, repeat exposures etc. These are encoded in the contextual OB operations:

           X = Conte(X)tual OB actions                                            [NORBI.X]
           ===========================                                                   ^

           This component is entirely optional - XMLChecking will not fail if there is no X value in the PROGTEMP.


           Survey            X      Action
           StePS             Any    Duplicate this OB the specified number of times (eg: 11331.7 = "duplicate this target configuration 7 times)
	   SCIP              <4     Duplicate this OB the specified number of times. OBs must be time-linked to ensure <72 hrs between first and last
	   IFUs (not LOFAR)  3,5,7  Initiate a dither sequence of 3,5 or 7 pointings
	   LOFAR             Any    Duplicate this OB the specified number of times (eg: 61331.7 = "duplicate this target configuration 7 times)

      -->

  </programme>   

  <observation name="%%%" progtemp="%%%" ob_priority="1.0" coordinate_system="ICRS" obs_type="%%%" semester="%%%" chained="%%%" obsgroup="%%%" ob_class="science" pa="%%%"> <!-- [["name": identifier for this OB (OB-id?)]]-->
      <configure plate="%%%" num_sky_fibres="%%%" max_calibration="25" max_guide="8" max_sky="100" maximum_gate_angle="14.1" config_file_version="%%%" configure_version="%%%" plate_version="%%%" seed="%%%" > <!-- [[max_sky should remain fixed - always aim for 100]]-->
    <conditions epoch="%%%" ha="%%%" relative_humidity="%%%" tlr="%%%" temperature="%%%" pressure="%%%"/> 
    <hour_angle_limits earliest="%%%" latest="%%%"/>
  </configure>
    <surveys>
      <survey name="%%%" priority="%%%" max_fibres="%%%"/>
      <!-- Set the per-field survey priorities based on the master fibre distribution policy
	   max_fibres - should this be ignored / removed?
      -->

    </surveys>

    <!-- The "obsconstraints" component must also inserted by the SWG at .fits -> .xml converter stage
	 (prior to running configure). Each target has an OBSTEMP value, which defines:

         OBSTEMP = "STAMB"
	 S = (S)eeing
	 T = (T)ransparency
	 A = (A)irmass/elevation
	 M = (M)oon distance            
	 B = Sky (B)rightness   
   
         (NB. ICS-026, the Scheduler, also lists OB priority; survey and programme priorities as possible inputs
         but does not list a moon distance constraint, whereas ICS-024, the OB manager, does)

         Each will be divided into grades (A,B,C,D,E) with "A" being the best, "E", the worst. SWG will need to
	 translate these into their numerical values, eg:

         OBSTEMP = "AAAAA"
	 S = "A" -> seeing_max="1.3"
	 T = "A" -> transparency_min="0.9"
	 A = "A" -> elevation_min="65.0"
         M = "A" -> moondist_min="120"
	 B = "A" -> skybright_max="21.9"

    --> 
    <obsconstraints obstemp="%%%" seeing_max="%%%" skybright_max="%%%" elevation_min="%%%" moondist_min="%%%" transparency_min="%%%"/> 
    <dithering apply_dither="0"/>
    <offsets offset_step_ra="0.0" offset_step_dec="0.0"/>

    <!--

    Example targets below taken from ICD-025 (Configure XML definition), including a few corrections to XML.
    
    --> 
    <fields>
    <field RA_d="%%%" Dec_d="%%%" order="%%%"> <!-- [[Decimal degrees]]-->
      <!-- Guide targets: -->
     <target targx="%%%" targy="%%%" fibreid="%%%" configid="%%%" cname="%%%" targid="%%%" targra="%%%" targdec="%%%" targpmra="%%%" targpmdec="%%%" targprio="%%%" targuse="G" targsrvy="%%%" targname="%%%" targprog="%%%" targclass="%%%" targcat="%%%" targepoch="%%%">
	<photometry mag_g="%%%" emag_g="%%%" mag_r="%%%" emag_r="%%%" mag_i="%%%" emag_i="%%%" mag_gg="%%%" emag_gg="%%%" mag_bp="%%%" emag_bp="%%%" mag_rp="%%%" emag_rp="%%%"/></target>
     <!-- ... -->
     <!-- ... -->
     <!-- Now science targets: -->

     <target targx="%%%" targy="%%%" fibreid="%%%" configid="%%%" cname="%%%" targid="%%%" targra="%%%" targdec="%%%" targpmra="%%%" targpmdec="%%%" targprio="%%%" targuse="T" targsrvy="%%%" targname="%%%" targprog="%%%" targclass="%%%" targcat="%%%" targepoch="%%%" ifu_spaxel="%%%">
       <photometry mag_g="%%%" emag_g="%%%" mag_r="%%%" emag_r="%%%" mag_i="%%%" emag_i="%%%" mag_gg="%%%" emag_gg="%%%" mag_bp="%%%" emag_bp="%%%" mag_rp="%%%" emag_rp="%%%"/>
       <simulation targid="%%%" template="%%%" mag="%%%" filterid="%%%" redshift="%%%" velocity="%%%" fwhm="%%%" ifu_spaxel="%%%" dither_id="%%%"/></target>
     <!-- ... -->
     <!-- ... -->
     <!-- Now calibration targets: -->
     <target targx="%%%" targy="%%%" fibreid="%%%" configid="%%%" cname="%%%" targid="%%%" targra="%%%" targdec="%%%" targpmra="%%%" targpmdec="%%%" targprio="%%%" targuse="C" targsrvy="%%%" targname="%%%" targprog="%%%" targclass="%%%" targcat="%%%" targepoch="%%%">
       <photometry mag_g="%%%" emag_g="%%%" mag_r="%%%" emag_r="%%%" mag_i="%%%" emag_i="%%%" mag_gg="%%%" emag_gg="%%%" mag_bp="%%%" emag_bp="%%%" mag_rp="%%%" emag_rp="%%%"/>
       <simulation targid="%%%" template="%%%" mag="%%%" filterid="%%%" redshift="%%%" velocity="%%%" fwhm="%%%" ifu_spaxel="%%%" dither_id="%%%"/></target>
      <!-- ... -->
      <!-- ... -->
      <!-- Now sky targets: -->
     <target targx="%%%" targy="%%%" fibreid="%%%" configid="%%%" cname="" targid="%%%" targra="%%%" targdec="%%%" targpmra="%%%" targpmdec="%%%" targprio="%%%" targuse="S" targsrvy="%%%" targname="%%%" targprog="%%%" targclass="%%%" targcat="%%%" targepoch="%%%" ifu_spaxel="%%%"/>
      <!-- ... -->
      <!-- ... -->
      <!-- ... -->
      <!-- ... -->
    </field>
    </fields>
  </observation> 
</root>
